{% extends "base.html" %}
{% block content %}

<!-- Summary + Month nav -->
<div class="card">
  <div class="row" style="align-items:center; justify-content:space-between">
    <div>
      <h2>{{ year }}-{{ "%02d"|format(month) }} Summary</h2>
      <div>Income: <strong>{{ "%.2f"|format(income) }}</strong></div>
      <div>Expense: <strong>{{ "%.2f"|format(expense) }}</strong></div>
      <div>Balance: <strong>{{ "%.2f"|format(balance) }}</strong></div>
    </div>
    <div class="row">
      <a href="{{ url_for('index', year=prev_year, month=prev_month, date_from=date_from, date_to=date_to, category=selected_category) }}">◀ Prev</a>
      &nbsp;|&nbsp;
      <a href="{{ url_for('index', year=next_year, month=next_month, date_from=date_from, date_to=date_to, category=selected_category) }}">Next ▶</a>
    </div>
  </div>

  <div style="margin-top:.5rem">
    <form method="post" action="{{ url_for('set_budget') }}" class="row">
      <input type="hidden" name="year" value="{{ year }}">
      <input type="hidden" name="month" value="{{ month }}">
      <input type="number" step="0.01" name="budget_amount" placeholder="Monthly budget" value="{{ budget or '' }}">
      <button type="submit">Save Budget</button>
    </form>
    {% if budget and progress_pct is not none %}
      <p style="margin:.5rem 0 0">
        Budget: {{ "%.2f"|format(budget) }} | Spent: {{ "%.2f"|format(expense) }} | Remaining: {{ "%.2f"|format(remaining) }}
      </p>
      <div class="progress" title="{{ progress_pct }}%">
        <div style="width: {{ progress_pct }}%"></div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Filters -->
<div class="card">
  <h3>Filters</h3>
  <form method="get" action="{{ url_for('index') }}">
    <div class="row">
      <label>From: <input type="date" name="date_from" value="{{ date_from }}"></label>
      <label>To: <input type="date" name="date_to" value="{{ date_to }}"></label>
      <label>Category:
        <select name="category">
          <option value="" {% if not selected_category %}selected{% endif %}>All</option>
          {% for c in categories %}
            <option value="{{ c }}" {% if selected_category==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </label>
      <input type="hidden" name="year" value="{{ year }}">
      <input type="hidden" name="month" value="{{ month }}">
      <button type="submit">Apply</button>
    </div>
  </form>
</div>

<!-- Add -->
<div class="card">
  <h3>Add Transaction</h3>
  <form method="post" action="{{ url_for('add') }}">
    <div class="row">
      <input type="date" name="tx_date" value="{{ today }}" required>
      <select name="kind" required>
        <option value="expense">Expense</option>
        <option value="income">Income</option>
      </select>
      <input type="text" name="category" placeholder="Category (e.g., Food)">
      <input type="number" step="0.01" name="amount" placeholder="Amount" required>
      <input type="text" name="note" placeholder="Note (optional)" style="flex:1">
      <button type="submit">Add</button>
    </div>
  </form>
</div>

<!-- Transactions -->
<div class="card">
  <div class="row" style="justify-content:space-between; align-items:center">
    <h3 style="margin:0">Transactions</h3>
    <div class="row">
      <a href="{{ url_for('export_csv', year=year, month=month, date_from=date_from, date_to=date_to, category=selected_category) }}">Export CSV</a>
      <a href="{{ url_for('export_xlsx', year=year, month=month, date_from=date_from, date_to=date_to, category=selected_category) }}">Export Excel</a>
    </div>
  </div>

  {% if txs %}
  <table style="margin-top:.5rem">
    <tr>
      <th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th>Note</th><th></th>
    </tr>
    {% for t in txs %}
    <tr>
      <td>{{ t['tx_date'] }}</td>
      <td>{{ t['kind'] }}</td>
      <td>{{ t['category'] }}</td>
      <td>{{ '%.2f'|format(t['amount']) }}</td>
      <td>{{ t['note'] }}</td>
      <td class="row">
        <a href="{{ url_for('edit', tx_id=t['id']) }}">Edit</a>
        <form method="post" action="{{ url_for('delete', tx_id=t['id']) }}" onsubmit="return confirm('Delete this transaction?');">
          <button type="submit">Delete</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>
  {% else %}
    <p>No transactions yet.</p>
  {% endif %}
</div>

<!-- Category chart -->
{% if cat_pairs %}
<div class="card">
  <h3>Expenses by Category</h3>
  <canvas id="catChart"></canvas>
</div>
<script>
  const ctx = document.getElementById('catChart');
  const labels = {{ cat_pairs|map(attribute=0)|list|tojson }};
  const values = {{ cat_pairs|map(attribute=1)|list|tojson }};
  new Chart(ctx, {
    type: 'pie',
    data: { labels: labels, datasets: [{ data: values }] },
    options: { responsive: true }
  });
</script>
{% endif %}

{% endblock %}
